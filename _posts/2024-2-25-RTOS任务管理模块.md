---
title: RTOS任务管理模块
date: 2024-02-25 13:20:00 +0800
categories: [RTOS, 理论基础]
tags: [RTOS]
---

## 当前任务状态转换图
![当前任务状态转换图](/assets/img/post_img/RTOS/任务状态转换图.png)

## 任务的挂起
**概念**：展示禁止任务占用CPU运行，也就是无条件暂停任务运行，增加了挂起状态的任务状态切换图：
![新的任务状态转换图](/assets/img/post_img/RTOS/挂起状态切换图.png)

## 实现
1. 添加挂起计数器：记录任务被挂起的次数
2. 编写挂起函数与唤醒函数：
```c
void taskSuspend(task_t* task) {
	uint32_t st = enterCritical();
	
	if (task->state & TASK_STATUS_DELAY) {
		leaveCritical(st);
		return;
	}
	
	if (task->suspendCounter++ == 0) {
		taskSched2Unready(task);
		task->state |= TASK_STATUS_SUSPEND;
		if (task == currentTask) {
			taskSched();
		}
	}
	
	leaveCritical(st);
}


void taskWakeUp(task_t* task) {
	uint32_t st = enterCritical();
	
	if (task->state & TASK_STATUS_SUSPEND) {
		if (--task->suspendCounter == 0) {
			task->state &= ~TASK_STATUS_SUSPEND;
			taskSched2Ready(task);
			taskSched();
		}
	}
	
	leaveCritical(st);
}
```

END